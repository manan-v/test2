[{"sha": "7786bf5af7ba1df1a8dd86183d5ac91cda08c86f", "filename": "bazel/external/quiche.BUILD", "status": "modified", "additions": 88, "deletions": 110, "changes": 198, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/bazel%2Fexternal%2Fquiche.BUILD", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/bazel%2Fexternal%2Fquiche.BUILD", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/bazel%2Fexternal%2Fquiche.BUILD?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -66,7 +66,7 @@ envoy_cc_test_library(\n     hdrs = [\"quiche/http2/test_tools/http2_random.h\"],\n     external_deps = [\"ssl\"],\n     repository = \"@envoy\",\n-    deps = [\":http2_platform\"],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -128,8 +128,8 @@ envoy_cc_test(\n     deps = [\n         \":http2_adapter_event_forwarder\",\n         \":quiche_common_platform_test\",\n-        \":spdy_core_mock_spdy_framer_visitor_lib\",\n         \":spdy_core_protocol_lib\",\n+        \":spdy_test_tools_mock_spdy_framer_visitor_lib\",\n     ],\n )\n \n@@ -309,7 +309,7 @@ envoy_cc_library(\n         \":http2_adapter_nghttp2_data_provider\",\n         \":http2_adapter_nghttp2_include\",\n         \":http2_adapter_nghttp2_util\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n         \":quiche_common_platform_export\",\n     ],\n )\n@@ -587,7 +587,7 @@ envoy_cc_library(\n     copts = quiche_copts,\n     repository = \"@envoy\",\n     deps = [\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n         \":quiche_common_platform_export\",\n     ],\n )\n@@ -670,31 +670,14 @@ envoy_cc_library(\n     ],\n )\n \n-envoy_cc_library(\n-    name = \"http2_platform\",\n-    hdrs = [\n-        \"quiche/http2/platform/api/http2_bug_tracker.h\",\n-        \"quiche/http2/platform/api/http2_flag_utils.h\",\n-        \"quiche/http2/platform/api/http2_flags.h\",\n-        \"quiche/http2/platform/api/http2_logging.h\",\n-        # TODO: uncomment the following files as implementations are added.\n-        # \"quiche/http2/platform/api/http2_test_helpers.h\",\n-    ],\n-    repository = \"@envoy\",\n-    visibility = [\"//visibility:public\"],\n-    deps = [\n-        \":quiche_common_platform\",\n-    ],\n-)\n-\n envoy_cc_library(\n     name = \"http2_constants_lib\",\n     srcs = [\"quiche/http2/http2_constants.cc\"],\n     hdrs = [\"quiche/http2/http2_constants.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n     deps = [\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n         \":quiche_common_text_utils_lib\",\n     ],\n )\n@@ -707,7 +690,7 @@ envoy_cc_library(\n     repository = \"@envoy\",\n     deps = [\n         \":http2_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -717,7 +700,7 @@ envoy_cc_library(\n     hdrs = [\"quiche/http2/decoder/decode_buffer.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n-    deps = [\":http2_platform\"],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -729,8 +712,8 @@ envoy_cc_library(\n     deps = [\n         \":http2_constants_lib\",\n         \":http2_decoder_decode_buffer_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -740,7 +723,7 @@ envoy_cc_library(\n     hdrs = [\"quiche/http2/decoder/decode_status.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n-    deps = [\":http2_platform\"],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -755,8 +738,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_structure_decoder_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -790,8 +773,8 @@ envoy_cc_library(\n         \":http2_decoder_payload_decoders_window_update_payload_decoder_lib\",\n         \":http2_decoder_structure_decoder_lib\",\n         \":http2_hpack_varint_hpack_varint_decoder_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -819,8 +802,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -836,8 +819,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -853,8 +836,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -870,8 +853,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -887,8 +870,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -904,8 +887,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -921,8 +904,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -938,8 +921,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -955,8 +938,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -972,8 +955,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -989,8 +972,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1010,8 +993,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n         \":quiche_common_platform_export\",\n     ],\n )\n@@ -1029,8 +1012,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n         \":http2_decoder_frame_decoder_state_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1044,8 +1027,8 @@ envoy_cc_library(\n         \":http2_decoder_decode_buffer_lib\",\n         \":http2_decoder_decode_http2_structures_lib\",\n         \":http2_decoder_decode_status_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1061,7 +1044,7 @@ envoy_cc_library(\n         \":http2_hpack_decoder_hpack_decoding_error_lib\",\n         \":http2_hpack_decoder_hpack_entry_decoder_lib\",\n         \":http2_hpack_decoder_hpack_entry_decoder_listener_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1080,7 +1063,7 @@ envoy_cc_library(\n         \":http2_hpack_decoder_hpack_decoder_tables_lib\",\n         \":http2_hpack_decoder_hpack_decoding_error_lib\",\n         \":http2_hpack_decoder_hpack_whole_entry_buffer_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1092,7 +1075,7 @@ envoy_cc_library(\n     repository = \"@envoy\",\n     deps = [\n         \":http2_hpack_hpack_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1110,7 +1093,7 @@ envoy_cc_library(\n         \":http2_hpack_decoder_hpack_decoding_error_lib\",\n         \":http2_hpack_decoder_hpack_whole_entry_listener_lib\",\n         \":http2_hpack_hpack_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1122,7 +1105,7 @@ envoy_cc_library(\n     repository = \"@envoy\",\n     deps = [\n         \":http2_hpack_huffman_hpack_huffman_decoder_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1136,8 +1119,8 @@ envoy_cc_library(\n         \":http2_constants_lib\",\n         \":http2_hpack_hpack_constants_lib\",\n         \":http2_hpack_hpack_static_table_entries_lib\",\n-        \":http2_platform\",\n         \":quiche_common_circular_deque_lib\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1166,7 +1149,7 @@ envoy_cc_library(\n         \":http2_hpack_decoder_hpack_entry_type_decoder_lib\",\n         \":http2_hpack_decoder_hpack_string_decoder_lib\",\n         \":http2_hpack_hpack_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1178,7 +1161,7 @@ envoy_cc_library(\n     repository = \"@envoy\",\n     deps = [\n         \":http2_hpack_hpack_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1193,7 +1176,7 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_hpack_hpack_constants_lib\",\n         \":http2_hpack_varint_hpack_varint_decoder_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1207,7 +1190,7 @@ envoy_cc_library(\n         \":http2_decoder_decode_buffer_lib\",\n         \":http2_decoder_decode_status_lib\",\n         \":http2_hpack_varint_hpack_varint_decoder_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1217,7 +1200,7 @@ envoy_cc_library(\n     hdrs = [\"quiche/http2/hpack/decoder/hpack_string_decoder_listener.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n-    deps = [\":http2_platform\"],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -1232,7 +1215,7 @@ envoy_cc_library(\n         \":http2_hpack_decoder_hpack_entry_decoder_listener_lib\",\n         \":http2_hpack_decoder_hpack_whole_entry_listener_lib\",\n         \":http2_hpack_hpack_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n         \":quiche_common_text_utils_lib\",\n     ],\n )\n@@ -1247,7 +1230,7 @@ envoy_cc_library(\n         \":http2_hpack_decoder_hpack_decoder_string_buffer_lib\",\n         \":http2_hpack_decoder_hpack_decoding_error_lib\",\n         \":http2_hpack_hpack_constants_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1257,10 +1240,7 @@ envoy_cc_library(\n     hdrs = [\"quiche/http2/hpack/huffman/hpack_huffman_decoder.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n-    deps = [\n-        \":http2_platform\",\n-        \":quiche_common_platform\",\n-    ],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -1271,7 +1251,6 @@ envoy_cc_library(\n     repository = \"@envoy\",\n     deps = [\n         \":http2_hpack_huffman_huffman_spec_tables_lib\",\n-        \":http2_platform\",\n         \":quiche_common_platform\",\n     ],\n )\n@@ -1293,7 +1272,7 @@ envoy_cc_library(\n     hdrs = [\"quiche/http2/hpack/http2_hpack_constants.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n-    deps = [\":http2_platform\"],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -1311,7 +1290,7 @@ envoy_cc_library(\n     deps = [\n         \":http2_decoder_decode_buffer_lib\",\n         \":http2_decoder_decode_status_lib\",\n-        \":http2_platform\",\n+        \":quiche_common_platform\",\n     ],\n )\n \n@@ -1321,7 +1300,7 @@ envoy_cc_library(\n     hdrs = [\"quiche/http2/hpack/varint/hpack_varint_encoder.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n-    deps = [\":http2_platform\"],\n+    deps = [\":quiche_common_platform\"],\n )\n \n envoy_cc_library(\n@@ -1378,7 +1357,6 @@ envoy_cc_library(\n     copts = quiche_copts,\n     repository = \"@envoy\",\n     deps = [\n-        \":http2_platform\",\n         \":quiche_common_platform\",\n         \":spdy_core_alt_svc_wire_format_lib\",\n         \":spdy_core_header_block_lib\",\n@@ -1437,7 +1415,6 @@ envoy_cc_library(\n         \":http2_decoder_decode_status_lib\",\n         \":http2_decoder_frame_decoder_lib\",\n         \":http2_decoder_frame_decoder_listener_lib\",\n-        \":http2_platform\",\n         \":http2_structures_lib\",\n         \":quiche_common_platform\",\n         \":spdy_core_alt_svc_wire_format_lib\",\n@@ -1504,16 +1481,16 @@ envoy_cc_library(\n )\n \n envoy_cc_test_library(\n-    name = \"spdy_core_mock_spdy_framer_visitor_lib\",\n-    srcs = [\"quiche/spdy/core/mock_spdy_framer_visitor.cc\"],\n-    hdrs = [\"quiche/spdy/core/mock_spdy_framer_visitor.h\"],\n+    name = \"spdy_test_tools_mock_spdy_framer_visitor_lib\",\n+    srcs = [\"quiche/spdy/test_tools/mock_spdy_framer_visitor.cc\"],\n+    hdrs = [\"quiche/spdy/test_tools/mock_spdy_framer_visitor.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n     deps = [\n         \":quiche_common_platform_test\",\n         \":spdy_core_http2_deframer_lib\",\n         \":spdy_core_recording_headers_handler_lib\",\n-        \":spdy_core_test_utils_lib\",\n+        \":spdy_test_tools_test_utils_lib\",\n     ],\n )\n \n@@ -1556,9 +1533,9 @@ envoy_cc_library(\n )\n \n envoy_cc_test_library(\n-    name = \"spdy_core_test_utils_lib\",\n-    srcs = [\"quiche/spdy/core/spdy_test_utils.cc\"],\n-    hdrs = [\"quiche/spdy/core/spdy_test_utils.h\"],\n+    name = \"spdy_test_tools_test_utils_lib\",\n+    srcs = [\"quiche/spdy/test_tools/spdy_test_utils.cc\"],\n+    hdrs = [\"quiche/spdy/test_tools/spdy_test_utils.h\"],\n     copts = quiche_copts,\n     repository = \"@envoy\",\n     deps = [\n@@ -1603,19 +1580,6 @@ envoy_cc_library(\n     ],\n )\n \n-envoy_cc_library(\n-    name = \"quic_platform_stream_buffer_allocator\",\n-    hdrs = [\n-        \"quiche/quic/platform/api/quic_stream_buffer_allocator.h\",\n-    ],\n-    repository = \"@envoy\",\n-    tags = [\"nofips\"],\n-    visibility = [\"//visibility:public\"],\n-    deps = [\n-        \":quiche_common_platform_stream_buffer_allocator\",\n-    ],\n-)\n-\n envoy_cc_library(\n     name = \"quic_platform_stack_trace\",\n     hdrs = [\n@@ -1629,19 +1593,6 @@ envoy_cc_library(\n     ],\n )\n \n-envoy_cc_library(\n-    name = \"quic_platform_containers\",\n-    hdrs = [\n-        \"quiche/quic/platform/api/quic_containers.h\",\n-    ],\n-    repository = \"@envoy\",\n-    tags = [\"nofips\"],\n-    visibility = [\"//visibility:public\"],\n-    deps = [\n-        \":quiche_common_platform_containers\",\n-    ],\n-)\n-\n envoy_cc_library(\n     name = \"quic_platform_server_stats\",\n     hdrs = [\n@@ -1686,10 +1637,8 @@ envoy_cc_library(\n     tags = [\"nofips\"],\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":quic_platform_containers\",\n         \":quic_platform_server_stats\",\n         \":quic_platform_stack_trace\",\n-        \":quic_platform_stream_buffer_allocator\",\n         \":quiche_common_buffer_allocator_lib\",\n         \":quiche_common_lib\",\n         \":quiche_common_platform_client_stats\",\n@@ -2736,6 +2685,30 @@ envoy_cc_library(\n     ],\n )\n \n+envoy_cc_library(\n+    name = \"quic_core_crypto_proof_source_x509_lib\",\n+    srcs = [\"quiche/quic/core/crypto/proof_source_x509.cc\"],\n+    hdrs = [\"quiche/quic/core/crypto/proof_source_x509.h\"],\n+    copts = quiche_copts,\n+    external_deps = [\n+        \"ssl\",\n+        \"abseil_node_hash_map\",\n+    ],\n+    repository = \"@envoy\",\n+    tags = [\"nofips\"],\n+    visibility = [\"//visibility:public\"],\n+    deps = [\n+        \":quic_core_crypto_certificate_view_lib\",\n+        \":quic_core_crypto_crypto_handshake_lib\",\n+        \":quic_core_crypto_encryption_lib\",\n+        \":quic_core_crypto_proof_source_lib\",\n+        \":quic_core_data_lib\",\n+        \":quic_platform_base\",\n+        \":quiche_common_endian_lib\",\n+        \"@com_google_absl//absl/base:core_headers\",\n+    ],\n+)\n+\n envoy_cc_library(\n     name = \"quic_core_crypto_client_proof_source_lib\",\n     srcs = [\n@@ -3240,7 +3213,7 @@ envoy_cc_library(\n     tags = [\"nofips\"],\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":quic_platform_containers\",\n+        \":quic_platform_export\",\n     ],\n )\n \n@@ -3268,6 +3241,7 @@ envoy_cc_library(\n     deps = [\n         \":quic_core_interval_lib\",\n         \":quic_platform_base\",\n+        \":quiche_common_platform_containers\",\n     ],\n )\n \n@@ -4591,6 +4565,7 @@ envoy_cc_test_library(\n         \":quic_core_crypto_crypto_handshake_lib\",\n         \":quic_core_crypto_encryption_lib\",\n         \":quic_core_crypto_proof_source_lib\",\n+        \":quic_core_crypto_proof_source_x509_lib\",\n         \":quic_core_crypto_random_lib\",\n         \":quic_core_data_lib\",\n         \":quic_core_framer_lib\",\n@@ -4608,6 +4583,7 @@ envoy_cc_test_library(\n         \":quic_core_time_wait_list_manager_lib\",\n         \":quic_core_utils_lib\",\n         \":quic_platform\",\n+        \":quic_platform_hostname_utils\",\n         \":quic_platform_test\",\n         \":quic_test_tools_config_peer_lib\",\n         \":quic_test_tools_connection_id_manager_peer_lib\",\n@@ -4617,6 +4593,7 @@ envoy_cc_test_library(\n         \":quic_test_tools_sent_packet_manager_peer_lib\",\n         \":quic_test_tools_simple_quic_framer_lib\",\n         \":quic_test_tools_stream_peer_lib\",\n+        \":quic_test_tools_test_certificates_lib\",\n         \":quiche_common_buffer_allocator_lib\",\n         \":quiche_common_test_tools_test_utils_lib\",\n         \":spdy_core_framer_lib\",\n@@ -5035,12 +5012,13 @@ envoy_cc_library(\n     ],\n )\n \n-envoy_quiche_platform_impl_cc_library(\n-    name = \"quiche_common_platform_default_quiche_platform_impl_export_impl_lib\",\n-    hdrs = [\n-        \"quiche/common/platform/default/quiche_platform_impl/quiche_export_impl.h\",\n-    ],\n-)\n+# Use the QUICHE default implmentation once the WIN32 compiler error is resolved.\n+# envoy_quiche_platform_impl_cc_library(\n+#    name = \"quiche_common_platform_default_quiche_platform_impl_export_impl_lib\",\n+#    hdrs = [\n+#        \"quiche/common/platform/default/quiche_platform_impl/quiche_export_impl.h\",\n+#    ],\n+#)\n \n envoy_quiche_platform_impl_cc_library(\n     name = \"quiche_common_platform_default_quiche_platform_impl_flag_utils_impl_lib\",\n@@ -5098,7 +5076,7 @@ envoy_cc_library(\n     tags = [\"nofips\"],\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":quiche_common_platform_default_quiche_platform_impl_export_impl_lib\",\n+        \"@envoy//source/common/quic/platform:quiche_export_impl_lib\",\n     ],\n )\n \n@@ -5233,8 +5211,8 @@ envoy_cc_test(\n     repository = \"@envoy\",\n     tags = [\"nofips\"],\n     deps = [\n-        \":http2_platform\",\n         \":http2_test_tools_random\",\n+        \":quiche_common_platform\",\n         \":quiche_common_test_tools_test_utils_lib\",\n     ],\n )\n@@ -5262,7 +5240,7 @@ envoy_cc_test(\n     tags = [\"nofips\"],\n     deps = [\n         \":spdy_core_header_block_lib\",\n-        \":spdy_core_test_utils_lib\",\n+        \":spdy_test_tools_test_utils_lib\",\n     ],\n )\n "}, {"sha": "15f6ed55b78364b80f06b14357c0889f832f947c", "filename": "bazel/repositories.bzl", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/bazel%2Frepositories.bzl", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/bazel%2Frepositories.bzl", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/bazel%2Frepositories.bzl?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -898,10 +898,6 @@ def _com_github_google_quiche():\n         name = \"quiche_http2_adapter\",\n         actual = \"@com_github_google_quiche//:http2_adapter\",\n     )\n-    native.bind(\n-        name = \"quiche_http2_platform\",\n-        actual = \"@com_github_google_quiche//:http2_platform\",\n-    )\n     native.bind(\n         name = \"quiche_spdy_platform\",\n         actual = \"@com_github_google_quiche//:spdy_platform\","}, {"sha": "8fd055d1d5ead59a595ab196d529b2015a9c3e17", "filename": "bazel/repository_locations.bzl", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/bazel%2Frepository_locations.bzl", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/bazel%2Frepository_locations.bzl", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/bazel%2Frepository_locations.bzl?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -892,12 +892,12 @@ REPOSITORY_LOCATIONS_SPEC = dict(\n         project_name = \"QUICHE\",\n         project_desc = \"QUICHE (QUIC, HTTP/2, Etc) is Google\u2018s implementation of QUIC and related protocols\",\n         project_url = \"https://github.com/google/quiche\",\n-        version = \"a05cb99d0b9a4c71629f0719e7280044f4843b22\",\n-        sha256 = \"5d4a0f7a720e58cca0e3b895fc561ed45c178d535a25c635657d52da1d891330\",\n+        version = \"3f73c4a23e365e2c2393a1af25cb891bd6432c67\",\n+        sha256 = \"641344d890708d634e090a78063183d783b67a57ac67a616feedc8de729f6288\",\n         urls = [\"https://github.com/google/quiche/archive/{version}.tar.gz\"],\n         strip_prefix = \"quiche-{version}\",\n         use_category = [\"dataplane_core\"],\n-        release_date = \"2022-04-25\",\n+        release_date = \"2022-05-09\",\n         cpe = \"N/A\",\n     ),\n     com_googlesource_googleurl = dict("}, {"sha": "5757ba4f3310950dd0cfb2216078361f99e606ca", "filename": "source/common/quic/platform/BUILD", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/source%2Fcommon%2Fquic%2Fplatform%2FBUILD", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/source%2Fcommon%2Fquic%2Fplatform%2FBUILD", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/source%2Fcommon%2Fquic%2Fplatform%2FBUILD?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -179,3 +179,10 @@ envoy_quiche_platform_impl_cc_library(\n     tags = [\"nofips\"],\n     deps = [\"//envoy/http:header_map_interface\"],\n )\n+\n+envoy_quiche_platform_impl_cc_library(\n+    name = \"quiche_export_impl_lib\",\n+    hdrs = [\"quiche_export_impl.h\"],\n+    external_deps = [\"abseil_base\"],\n+    tags = [\"nofips\"],\n+)"}, {"sha": "9cb2788428fe666e156a6f9da5f0441dc2137131", "filename": "source/common/quic/platform/quiche_export_impl.h", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/source%2Fcommon%2Fquic%2Fplatform%2Fquiche_export_impl.h", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/source%2Fcommon%2Fquic%2Fplatform%2Fquiche_export_impl.h", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/source%2Fcommon%2Fquic%2Fplatform%2Fquiche_export_impl.h?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -6,6 +6,17 @@\n // consumed or referenced directly by other Envoy code. It serves purely as a\n // porting layer for QUICHE.\n \n-#define QUICHE_EXPORT\n-#define QUICHE_EXPORT_PRIVATE\n-#define QUICHE_NO_EXPORT\n+#include \"absl/base/attributes.h\"\n+\n+// These macros are documented in: quiche/quic/platform/api/quic_export.h\n+\n+#if defined(_WIN32)\n+#define QUICHE_EXPORT_IMPL\n+#elif ABSL_HAVE_ATTRIBUTE(visibility)\n+#define QUICHE_EXPORT_IMPL __attribute__((visibility(\"default\")))\n+#else\n+#define QUICHE_EXPORT_IMPL\n+#endif\n+\n+#define QUICHE_EXPORT_PRIVATE_IMPL QUICHE_EXPORT_IMPL\n+#define QUICHE_NO_EXPORT_IMPL QUICHE_EXPORT_IMPL"}, {"sha": "f7b802127185694ea60650a7bac684f820744692", "filename": "source/common/quic/platform/quiche_stack_trace_impl.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/source%2Fcommon%2Fquic%2Fplatform%2Fquiche_stack_trace_impl.h", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/source%2Fcommon%2Fquic%2Fplatform%2Fquiche_stack_trace_impl.h", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/source%2Fcommon%2Fquic%2Fplatform%2Fquiche_stack_trace_impl.h?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -22,4 +22,7 @@ inline std::string QuicheStackTraceImpl() {\n   return os.str();\n }\n \n+// NOLINTNEXTLINE(readability-identifier-naming)\n+inline bool QuicheShouldRunStackTraceTestImpl() { return true; }\n+\n } // namespace quiche"}, {"sha": "75abe9ad027b55bec102a398ad86e4034aad3498", "filename": "test/common/quic/BUILD", "status": "modified", "additions": 2, "deletions": 19, "changes": 21, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2FBUILD", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2FBUILD", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/test%2Fcommon%2Fquic%2FBUILD?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -72,7 +72,6 @@ envoy_cc_test(\n     tags = [\"nofips\"],\n     deps = [\n         \"//source/common/quic:quic_filter_manager_connection_lib\",\n-        \"//test/common/quic:quic_test_utils_for_envoy_lib\",\n         \"//test/mocks/event:event_mocks\",\n         \"//test/mocks/network:network_mocks\",\n         \"//test/test_common:utility_lib\",\n@@ -110,7 +109,6 @@ envoy_cc_test(\n     srcs = [\"envoy_quic_server_stream_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n         \":test_utils_lib\",\n         \"//source/common/http:headers_lib\",\n         \"//source/common/quic:envoy_quic_alarm_factory_lib\",\n@@ -133,7 +131,6 @@ envoy_cc_test(\n     srcs = [\"envoy_quic_client_stream_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n         \":test_utils_lib\",\n         \"//source/common/http:headers_lib\",\n         \"//source/common/quic:envoy_quic_alarm_factory_lib\",\n@@ -154,7 +151,6 @@ envoy_cc_test(\n     srcs = [\"envoy_quic_server_session_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n         \":test_proof_source_lib\",\n         \":test_utils_lib\",\n         \"//envoy/stats:stats_macros\",\n@@ -183,7 +179,6 @@ envoy_cc_test(\n     srcs = [\"envoy_quic_client_session_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n         \":test_utils_lib\",\n         \"//envoy/stats:stats_macros\",\n         \"//source/common/quic:codec_lib\",\n@@ -207,7 +202,7 @@ envoy_cc_test(\n     srcs = [\"active_quic_listener_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n+        \":test_proof_source_lib\",\n         \":test_utils_lib\",\n         \"//source/common/http:utility_lib\",\n         \"//source/common/network:udp_packet_writer_handler_lib\",\n@@ -232,7 +227,6 @@ envoy_cc_test(\n     srcs = [\"envoy_quic_dispatcher_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n         \":test_proof_source_lib\",\n         \":test_utils_lib\",\n         \"//envoy/stats:stats_macros\",\n@@ -273,17 +267,6 @@ envoy_cc_test_library(\n     ],\n )\n \n-envoy_cc_test_library(\n-    name = \"quic_test_utils_for_envoy_lib\",\n-    srcs = [\"crypto_test_utils_for_envoy.cc\"],\n-    tags = [\"nofips\"],\n-    deps = [\n-        \":test_proof_source_lib\",\n-        \":test_proof_verifier_lib\",\n-        \"@com_github_google_quiche//:quic_test_tools_test_utils_lib\",\n-    ],\n-)\n-\n envoy_cc_test(\n     name = \"client_connection_factory_impl_test\",\n     srcs = [\"client_connection_factory_impl_test.cc\"],\n@@ -326,10 +309,10 @@ envoy_cc_test(\n     srcs = [\"envoy_quic_utils_test.cc\"],\n     tags = [\"nofips\"],\n     deps = [\n-        \":quic_test_utils_for_envoy_lib\",\n         \"//source/common/quic:envoy_quic_utils_lib\",\n         \"//test/mocks/api:api_mocks\",\n         \"//test/test_common:threadsafe_singleton_injector_lib\",\n+        \"@com_github_google_quiche//:quic_test_tools_test_utils_lib\",\n     ],\n )\n "}, {"sha": "c0b18722f26bbd1c21d21ae19e1d2472c2a7cab4", "filename": "test/common/quic/crypto_test_utils_for_envoy.cc", "status": "removed", "additions": 0, "deletions": 34, "changes": 34, "blob_url": "https://github.com/10gen/envoy-serverless/blob/9ac23b5571c32b8ad32fce9e2e300c1147ec9847/test%2Fcommon%2Fquic%2Fcrypto_test_utils_for_envoy.cc", "raw_url": "https://github.com/10gen/envoy-serverless/raw/9ac23b5571c32b8ad32fce9e2e300c1147ec9847/test%2Fcommon%2Fquic%2Fcrypto_test_utils_for_envoy.cc", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/test%2Fcommon%2Fquic%2Fcrypto_test_utils_for_envoy.cc?ref=9ac23b5571c32b8ad32fce9e2e300c1147ec9847", "patch": "@@ -1,34 +0,0 @@\n-// NOLINT(namespace-envoy)\n-\n-// This file defines platform dependent test utility functions which is declared\n-// in quiche/quic/test_tools/crypto_test_utils.h.\n-\n-#include <memory>\n-\n-#include \"test/common/quic/test_proof_source.h\"\n-#include \"test/common/quic/test_proof_verifier.h\"\n-\n-#include \"quiche/quic/test_tools/crypto_test_utils.h\"\n-\n-namespace quic {\n-namespace test {\n-namespace crypto_test_utils {\n-// NOLINTNEXTLINE(readability-identifier-naming)\n-std::unique_ptr<ProofSource> ProofSourceForTesting() {\n-  return std::make_unique<Envoy::Quic::TestProofSource>();\n-}\n-\n-// NOLINTNEXTLINE(readability-identifier-naming)\n-std::unique_ptr<ProofVerifier> ProofVerifierForTesting() {\n-  return std::make_unique<Envoy::Quic::TestProofVerifier>();\n-}\n-\n-// NOLINTNEXTLINE(readability-identifier-naming)\n-std::unique_ptr<ProofVerifyContext> ProofVerifyContextForTesting() {\n-  // No context needed for fake verifier.\n-  return nullptr;\n-}\n-\n-} // namespace crypto_test_utils\n-} // namespace test\n-} // namespace quic"}, {"sha": "8ac59840e1989495987793c64f52444fdac270e0", "filename": "test/common/quic/platform/BUILD", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2Fplatform%2FBUILD", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2Fplatform%2FBUILD", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/test%2Fcommon%2Fquic%2Fplatform%2FBUILD?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -12,18 +12,6 @@ licenses([\"notice\"])  # Apache 2\n \n envoy_package()\n \n-envoy_cc_test(\n-    name = \"http2_platform_test\",\n-    srcs = [\"http2_platform_test.cc\"],\n-    external_deps = [\"quiche_http2_platform\"],\n-    deps = [\n-        \"//source/common/quic/platform:quiche_flags_impl_lib\",\n-        \"//test/test_common:logging_lib\",\n-        \"//test/test_common:utility_lib\",\n-        \"@com_github_google_quiche//:http2_test_tools_random\",\n-    ],\n-)\n-\n envoy_cc_test(\n     name = \"quic_platform_test\",\n     srcs = select({\n@@ -57,6 +45,7 @@ envoy_cc_test(\n         \"@com_github_google_quiche//:quic_platform_test_output\",\n         \"@com_github_google_quiche//:quic_platform_thread\",\n         \"@com_github_google_quiche//:quiche_common_mem_slice_storage\",\n+        \"@com_github_google_quiche//:quiche_common_platform_stream_buffer_allocator\",\n         \"@com_github_google_quiche//:quiche_common_platform_system_event_loop\",\n     ],\n )"}, {"sha": "caa8cbd3508f9d2b5ca82aa8caf16b37b1065424", "filename": "test/common/quic/platform/quic_platform_test.cc", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2Fplatform%2Fquic_platform_test.cc", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2Fplatform%2Fquic_platform_test.cc", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/test%2Fcommon%2Fquic%2Fplatform%2Fquic_platform_test.cc?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -26,13 +26,13 @@\n #include \"gmock/gmock.h\"\n #include \"gtest/gtest.h\"\n #include \"quiche/common/platform/api/quiche_mem_slice.h\"\n+#include \"quiche/common/platform/api/quiche_stream_buffer_allocator.h\"\n #include \"quiche/common/platform/api/quiche_system_event_loop.h\"\n #include \"quiche/common/quiche_mem_slice_storage.h\"\n #include \"quiche/epoll_server/fake_simple_epoll_server.h\"\n #include \"quiche/quic/core/quic_epoll_clock.h\"\n #include \"quiche/quic/platform/api/quic_bug_tracker.h\"\n #include \"quiche/quic/platform/api/quic_client_stats.h\"\n-#include \"quiche/quic/platform/api/quic_containers.h\"\n #include \"quiche/quic/platform/api/quic_expect_bug.h\"\n #include \"quiche/quic/platform/api/quic_exported_stats.h\"\n #include \"quiche/quic/platform/api/quic_flags.h\"\n@@ -42,7 +42,6 @@\n #include \"quiche/quic/platform/api/quic_mutex.h\"\n #include \"quiche/quic/platform/api/quic_server_stats.h\"\n #include \"quiche/quic/platform/api/quic_stack_trace.h\"\n-#include \"quiche/quic/platform/api/quic_stream_buffer_allocator.h\"\n #include \"quiche/quic/platform/api/quic_test.h\"\n #include \"quiche/quic/platform/api/quic_test_output.h\"\n #include \"quiche/quic/platform/api/quic_thread.h\"\n@@ -585,7 +584,7 @@ class FileUtilsTest : public testing::Test {\n };\n \n TEST_F(QuicPlatformTest, TestEnvoyQuicBufferAllocator) {\n-  QuicStreamBufferAllocator allocator;\n+  quiche::QuicheStreamBufferAllocator allocator;\n   Envoy::Stats::TestUtil::MemoryTest memory_test;\n   if (memory_test.mode() == Envoy::Stats::TestUtil::MemoryTest::Mode::Disabled) {\n     return;"}, {"sha": "95eebcf5a82fec4afcb41056ac9ca1e6c6ad72ed", "filename": "test/common/quic/platform/quiche_test_impl.h", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2Fplatform%2Fquiche_test_impl.h", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fcommon%2Fquic%2Fplatform%2Fquiche_test_impl.h", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/test%2Fcommon%2Fquic%2Fplatform%2Fquiche_test_impl.h?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -27,8 +27,8 @@ inline std::string QuicheGetTestMemoryCachePathImpl() { // NOLINT(readability-id\n namespace quiche {\n namespace test {\n \n-using QuicheTest = ::testing::Test;\n-using QuicTestImpl = QuicheTest;\n+using QuicheTestImpl = ::testing::Test;\n+using QuicTestImpl = QuicheTestImpl;\n \n template <class T> using QuicheTestWithParamImpl = ::testing::TestWithParam<T>;\n template <class T> using QuicTestWithParamImpl = QuicheTestWithParamImpl<T>;"}, {"sha": "b16c9f9b9b6c3867078b1a9fc2d5c2f18162c925", "filename": "test/integration/BUILD", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/10gen/envoy-serverless/blob/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fintegration%2FBUILD", "raw_url": "https://github.com/10gen/envoy-serverless/raw/f2b3fb39955414720718fdb8ccb4e0fb815523bf/test%2Fintegration%2FBUILD", "contents_url": "https://api.github.com/repos/10gen/envoy-serverless/contents/test%2Fintegration%2FBUILD?ref=f2b3fb39955414720718fdb8ccb4e0fb815523bf", "patch": "@@ -1817,7 +1817,6 @@ envoy_cc_test(\n         \"//source/common/quic:envoy_quic_connection_helper_lib\",\n         \"//source/common/quic:envoy_quic_proof_verifier_lib\",\n         \"//source/common/quic:quic_factory_lib\",\n-        \"//test/common/quic:quic_test_utils_for_envoy_lib\",\n         \"//test/common/quic:test_utils_lib\",\n         \"//test/integration/filters:encoder_decoder_buffer_filter_lib\",\n         \"//test/test_common:test_runtime_lib\","}]